<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>띄어쓰기 레이스 V3.2 — Fancy Race (Sections)</title>
<style>
:root{
  --bg:#f7fbff; --panel:#ffffff; --text:#0b1020; --sub:#475569;
  --accent:#2563eb; --accent2:#f59e0b; --boss:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Pretendard,Segoe UI,Arial,sans-serif}
.app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header,footer{padding:10px 14px;background:var(--panel);border-bottom:1px solid #e5e7eb}
footer{border-top:1px solid #e5e7eb;border-bottom:none;color:var(--sub)}
.brand{font-weight:800}
.badge{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;background:#e5ecff;color:#0b1020}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#fff;border:1px solid #e5e7eb}
.map-wrap{height:54vh;min-height:320px;overflow:hidden;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb;position:relative}
.map-inner{height:100%;width:3200px;position:relative;transition:transform .45s cubic-bezier(.22,.61,.36,1)}
.track{position:absolute;left:40px;bottom:42%;height:16px;width:3000px;background:#e6eeff;border-radius:8px;box-shadow:inset 0 2px 0 #dbe5ff, 0 6px 18px rgba(0,0,0,.08)}
.section{position:absolute;inset:0 auto 0 0;height:100%;width:800px;opacity:.9}
.sec-forest{background:linear-gradient(180deg,#e7f8ec,#f6fff7)}
.sec-space{left:800px;background:linear-gradient(180deg,#eef1ff,#f7f7ff)}
.sec-sports{left:1600px;background:linear-gradient(180deg,#fff6e6,#fffaf0)}
.sec-candy{left:2400px;background:linear-gradient(180deg,#fff0f7,#fff7fb)}
.section .label{position:absolute;top:10px;left:10px;font-weight:700;color:#334155}
.cell{position:absolute;bottom:calc(42% + 8px);transform:translateX(-50%);width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid #e5e7eb;background:#fff;color:#1f2937}
.cell.pickup{border-color:var(--accent2);background:#fff7ed}
.cell.boss{border-color:var(--boss);background:#fff1f2}
.cell.goal{border-color:#22c55e;background:#f0fdf4}
.dec{position:absolute;bottom:60%;font-size:22px;opacity:.9;transform:translateX(-50%)}
.player{position:absolute;bottom:calc(42% + 58px);transform:translateX(-50%);width:56px;height:56px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,.12);border:2px solid #e5e7eb; z-index:3}
.quiz{padding:14px;display:grid;gap:10px;background:var(--panel)}
.answers{display:grid;gap:8px}
.answers button{font-size:18px;padding:12px;border-radius:14px;background:#f3f4f6;border:1px solid #e5e7eb;text-align:left;color:#111827}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.slot{min-width:90px;min-height:40px;border:2px dashed #d1d5db;border-radius:12px;padding:6px 8px;font-size:13px;display:flex;align-items:center;justify-content:center;background:#fff}
.slot.filled{border-style:solid;background:#eef2ff}
.dice{min-width:54px;height:54px;border-radius:12px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.08);user-select:none;border:2px solid #e5e7eb}
@keyframes roll { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
.dice.rolling{animation:roll .8s ease}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:10;display:none}
.modal{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.35);z-index:20}
.dialog{background:#fff;border:1px solid #e5e7eb;padding:18px;border-radius:14px;min-width:320px;color:#0b1020}
.picker{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
.picker button{font-size:28px;padding:10px;border-radius:12px;border:2px solid #e5e7eb;background:#fff;cursor:pointer;position:relative}
.picker button.selected{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.2)}
.picker button.selected::after{content:'✓';position:absolute;top:-10px;right:-10px;background:var(--accent);color:#fff;width:22px;height:22px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:14px}
.p2-sel .picker button.selected{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.2)}
.p2-sel .picker button.selected::after{background:#ef4444}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div class="brand">🏁 띄어쓰기 레이스</div>
      <span class="badge">턴: <span id="turnLabel">P1</span></span>
      <span class="badge">⏱ <span id="timeLeft">10:00</span></span>
      <span class="badge" id="volBadge">🔊 25%</span>
      <span class="badge" style="background:#dcfce7;color:#065f46">BUILD v3.2</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="fsBtn" class="btn ghost">전체화면</button>
    </div>
  </header>

  <div class="map-wrap">
    <div class="map-inner" id="mapInner">
      <!-- Section bands -->
      <div class="section sec-forest"><div class="label">🌳 Forest</div></div>
      <div class="section sec-space"><div class="label">✨ Space</div></div>
      <div class="section sec-sports"><div class="label">🏟 Sports</div></div>
      <div class="section sec-candy"><div class="label">🍭 Candy</div></div>

      <div class="track"></div>
      <div id="cells"></div>
      <div id="decos"></div>
      <div class="player" id="p1" style="left:40px">🙂</div>
      <div class="player" id="p2" style="left:40px">😎</div>
    </div>
  </div>

  <section class="quiz" aria-live="polite">
    <div class="row">
      <div>🎒 슬롯:</div>
      <div class="slot" id="itemSlot">비어있음</div>
      <button id="useItemBtn" class="btn" disabled>아이템 사용</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="dice" id="dice" title="주사위">—</div>
      </div>
    </div>
    <div class="q-stem" id="qStem">캐릭터 선택 후 <b>게임 시작</b>을 누르면 진행됩니다.</div>
    <div class="answers">
      <button id="a1" disabled>—</button>
      <button id="a2" disabled>—</button>
    </div>
  </section>

  <footer><small>정답: 1~6 전진, 오답: 0~2 후퇴. 🎁/B/🏁은 정확히 착지해야 발동. 섹션별 배경/장식이 달라요!</small></footer>
</div>

<div class="toast" id="toast">세로 모드예요. 가로로 돌리면 더 편해요!</div>

<!-- Character picker FIRST (blocks page) -->
<div class="modal" id="pickModal" role="dialog" aria-label="캐릭터 선택">
  <div class="dialog">
    <h3 style="margin:0">캐릭터 선택 후 <span style="color:#2563eb">게임 시작</span></h3>
    <p style="margin:6px 0 8px;color:#475569">플레이어1과 플레이어2를 각각 고르세요.</p>
    <div>플레이어1</div>
    <div class="picker" id="p1Pick">
      <button>🙂</button><button>🦊</button><button>🐱</button><button>🐧</button>
      <button>🐯</button><button>🦄</button><button>🐸</button><button>🐼</button>
    </div>
    <div style="margin-top:8px">플레이어2</div>
    <div class="picker p2-sel" id="p2Pick">
      <button>😎</button><button>🐶</button><button>🐤</button><button>🐵</button>
      <button>🦁</button><button>🐨</button><button>🐰</button><button>🐻</button>
    </div>
    <div class="modal-actions">
      <button id="startBtn" class="btn primary" disabled>게임 시작</button>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);

// Audio
const AudioBank = {
  sfx: {
    correct: new Audio("assets/sfx/correct.wav"),
    wrong:   new Audio("assets/sfx/wrong.wav"),
    item:    new Audio("assets/sfx/item.wav"),
    boss:    new Audio("assets/sfx/boss.wav"),
    click:   new Audio("assets/sfx/click.wav")
  },
  bgm: new Audio("assets/sfx/bgm_loop.wav"),
  volume: 0.25,
  setVolume(v){ this.volume=v; Object.values(this.sfx).forEach(a=>a.volume=Math.min(1,v+0.1)); this.bgm.volume=v; $('#volBadge').textContent=`🔊 ${Math.round(v*100)}%`; },
  play(name){ const a=this.sfx[name]; if(!a) return; a.currentTime=0; a.play().catch(()=>{}); },
  startBgm(){ this.bgm.loop=true; this.bgm.volume=this.volume; this.bgm.play().catch(()=>{}); },
  unlock(){ try{ Object.values(this.sfx).forEach(a=>a.play().then(()=>a.pause()).catch(()=>{})); this.bgm.play().then(()=>this.bgm.pause()).catch(()=>{}); }catch(e){} }
};

// State
const S = {
  minutes:10, timeLeft:600, playing:false,
  cur:1,
  p1:{ char:'🙂', idx:0, item:null, shield:false },
  p2:{ char:'😎', idx:0, item:null, shield:false },
  path:[], pendingMove:0,
  sections:[
    {theme:'forest', len:10, deco:'🌿'},
    {theme:'space',  len:10, deco:'✨'},
    {theme:'sports', len:10, deco:'🏟'},
    {theme:'candy',  len:10, deco:'🍬'}
  ]
};

// Build board with sections
function genBoard(){
  const arr=[]; let x=40; const step=72; let idx=0;
  const pickups=[4,7,12,15,19,23,28,31,35];
  const bosses=[14,27];
  const total = S.sections.reduce((a,s)=>a+s.len,0);
  for(let i=0;i<total;i++){
    arr.push({x, type:'NORMAL', section:sectionOfIndex(i)});
    x += step; idx++;
  }
  pickups.forEach(i=>{ if(arr[i]) arr[i].type='PICKUP'; });
  bosses.forEach(i=>{ if(arr[i]) arr[i].type='BOSS'; });
  arr[total-1].type='GOAL';
  S.path=arr;
}

// map index => section name
function sectionOfIndex(i){
  let sum=0;
  for(const s of S.sections){
    const start=sum; const end=sum + s.len - 1;
    if(i>=start && i<=end) return s.theme;
    sum += s.len;
  }
  return S.sections[S.sections.length-1].theme;
}

function drawBoard(){
  const cells=$('#cells'); cells.innerHTML='';
  const decos=$('#decos'); decos.innerHTML='';
  const emoji = {forest:'🌳', space:'✨', sports:'🏃', candy:'🍭'};
  S.path.forEach((n,i)=>{
    const d=document.createElement('div'); d.className='cell'; d.style.left=n.x+'px';
    if(n.type==='PICKUP'){ d.classList.add('pickup'); d.textContent='🎁'; }
    else if(n.type==='BOSS'){ d.classList.add('boss'); d.textContent='B'; }
    else if(n.type==='GOAL'){ d.classList.add('goal'); d.textContent='🏁'; }
    else d.textContent=emoji[n.section]+' '+i;
    cells.appendChild(d);

    // little decoration per 3 cells
    if(i%3===0 && n.type==='NORMAL'){
      const deco=document.createElement('div'); deco.className='dec'; deco.style.left=n.x+'px';
      deco.textContent = ({forest:'🌲',space:'🌟',sports:'🏅',candy:'🍬'})[n.section];
      decos.appendChild(deco);
    }
  });
}

function placePlayers(){
  ['p1','p2'].forEach((id,i)=>{
    const p=i===0?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
    $('#'+id).style.left = (n?n.x:40)+'px';
  });
}

function cameraFollow(){
  const p=S.cur===1?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
  const wrapW=document.querySelector('.map-wrap').clientWidth;
  const centered=Math.max(0, Math.min(n.x - wrapW*0.45, document.querySelector('.map-inner').scrollWidth - wrapW));
  document.querySelector('.map-inner').style.transform=`translateX(${-centered}px)`;
}

// Deck
let regularStack=[], bossStack=[];
async function loadDeck(){
  try{
    const r=await fetch('questions.json?ts='+Date.now()); const data=await r.json();
    regularStack = shuffle([...data.regular]); bossStack=shuffle([...data.boss]);
  }catch(e){
    regularStack=[{q:"나는밥을먹어요",correct:"나는 밥을 먹어요",wrong:"나는밥을 먹어요"}];
    bossStack=[{q:"학교앞에버스가와요",correct:"학교 앞에 버스가 와요",wrong:"학교앞 에 버스 가 와요"}];
  }
}
function drawQuestion(isBoss){
  const q=(isBoss? bossStack: regularStack).pop();
  if(!q){ $('#qStem').textContent='문제가 소진되었어요'; $('#a1').disabled=$('#a2').disabled=true; return null; }
  $('#qStem').innerHTML = `원문: <strong>${q.q}</strong> ${isBoss?'<span class="badge" style="background:#fee2e2;color:#991b1b">BOSS</span>':''}`;
  const opts = shuffle([{text:q.correct,ok:true},{text:q.wrong,ok:false}]);
  [$('#a1'),$('#a2')].forEach((b,i)=>{ b.textContent=opts[i].text; b.dataset.ok=opts[i].ok?'1':'0'; b.disabled=false; });
  return q;
}

// Utils
function shuffle(a){ return a.sort(()=>Math.random()-0.5) }
function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}` }
function current(){ return S.cur===1?S.p1:S.p2 }
function other(){ return S.cur===1?S.p2:S.p1 }

// Flow (auto dice)
function presentQuiz(){
  const isBoss = S.path[current().idx]?.type==='BOSS';
  drawQuestion(isBoss);
  cameraFollow();
  $('#dice').textContent='—';
}
function onAnswer(ok){
  ['a1','a2'].forEach(id=>$('#'+id).disabled=true);
  AudioBank.play(ok? 'correct':'wrong');
  autoRoll(ok);
}
function autoRoll(isCorrect){
  const dice=$('#dice'); dice.classList.add('rolling');
  let ticks=10, val=1;
  const timer=setInterval(()=>{
    val = isCorrect? (1+Math.floor(Math.random()*6)) : Math.floor(Math.random()*3);
    dice.textContent=String(val);
    if(--ticks<=0){
      clearInterval(timer); dice.classList.remove('rolling');
      S.pendingMove = isCorrect? val : -val;
      resolveMove();
    }
  },80);
}
function resolveMove(){
  const p=current();
  p.idx = Math.max(0, Math.min(p.idx + S.pendingMove, S.path.length-1));
  placePlayers(); cameraFollow();
  const tile=S.path[p.idx];
  if(tile?.type==='PICKUP' && !p.item){
    p.item = randItem(); $('#itemSlot').textContent=p.item; $('#itemSlot').classList.add('filled'); $('#useItemBtn').disabled=false; AudioBank.play('item');
  }
  if(tile?.type==='BOSS'){
    AudioBank.play('boss');
    const q = drawQuestion(true);
    if(q){
      const handler=(e)=>{
        const ok = e.currentTarget.dataset.ok==='1';
        ['a1','a2'].forEach(id=>$('#'+id).removeEventListener('click', handler));
        if(ok){ p.idx = Math.min(S.path.length-1, p.idx+2); }
        else { if(!p.shield){ p.idx = Math.max(0, p.idx-1); } else { p.shield=false; } }
        placePlayers(); cameraFollow();
        swapTurn();
      };
      ['a1','a2'].forEach(id=>$('#'+id).addEventListener('click', handler, {once:true}));
      return;
    }
  }
  if(tile?.type==='GOAL'){ $('#qStem').innerHTML=`<strong>P${S.cur} 골인! 🎉</strong>`; S.playing=false; return; }
  swapTurn();
}
function swapTurn(){ S.cur = S.cur===1?2:1; updateHUD(); presentQuiz(); }
function randItem(){ return shuffle(['BOOST','PUSH','BACK','SHIELD'])[0]; }
function useItem(){
  const p=current(); const it=p.item; if(!it) return;
  if(it==='BOOST'){ p.idx = Math.min(S.path.length-1, p.idx+2); }
  else if(it==='BACK'){ p.idx = Math.max(0, p.idx-1); }
  else if(it==='PUSH'){ const op=other(); op.idx = Math.max(0, op.idx-1); }
  else if(it==='SHIELD'){ p.shield=true; }
  p.item=null; $('#itemSlot').textContent='비어있음'; $('#itemSlot').classList.remove('filled'); $('#useItemBtn').disabled=true;
  placePlayers(); cameraFollow(); AudioBank.play('click');
}

// HUD/Timer
let timerId=null;
function updateHUD(){ $('#turnLabel').textContent=S.cur===1?'P1':'P2'; $('#timeLeft').textContent=fmt(S.timeLeft); }
function startTimer(){
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ if(!S.playing) return; S.timeLeft--; if(S.timeLeft<=0){ S.playing=false; $('#qStem').innerHTML='<strong>시간 종료!</strong>'; ['a1','a2'].forEach(id=>$('#'+id).disabled=true); } updateHUD(); },1000);
}

// Character picker (pre-game mandatory)
let p1Pick=null, p2Pick=null;
function updateStartEnabled(){ $('#startBtn').disabled = !(p1Pick && p2Pick); }
$('#p1Pick').addEventListener('click', e=>{
  if(e.target.tagName!=='BUTTON') return;
  [...$('#p1Pick').children].forEach(b=>b.classList.remove('selected'));
  e.target.classList.add('selected');
  p1Pick=e.target.textContent; updateStartEnabled();
});
$('#p2Pick').addEventListener('click', e=>{
  if(e.target.tagName!=='BUTTON') return;
  [...$('#p2Pick').children].forEach(b=>b.classList.remove('selected'));
  e.target.classList.add('selected');
  p2Pick=e.target.textContent; updateStartEnabled();
});
$('#startBtn').addEventListener('click', ()=>{
  AudioBank.unlock(); AudioBank.startBgm();
  $('#p1').textContent=p1Pick; $('#p2').textContent=p2Pick;
  document.getElementById('pickModal').style.display='none';
  boot();
});

// Boot
async function boot(){
  S.playing=true; S.cur=1; S.timeLeft=600;
  S.p1.idx=0; S.p2.idx=0; S.p1.item=null; S.p2.item=null;
  await loadDeck(); genBoard(); drawBoard(); placePlayers(); updateHUD(); presentQuiz(); startTimer();
}

// Answers & controls
document.getElementById('a1').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
document.getElementById('a2').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
document.getElementById('useItemBtn').addEventListener('click', useItem);
document.getElementById('fsBtn').addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });

// Orientation toast
function checkOrientation(){ const isPortrait = window.matchMedia('(orientation: portrait)').matches; document.getElementById('toast').style.display = isPortrait?'block':'none'; }
window.addEventListener('resize', checkOrientation); checkOrientation();
</script>
</body>
</html>