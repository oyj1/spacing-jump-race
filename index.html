<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>띄어쓰기 레이스 — Bright & Simple</title>
<style>
:root{
  --bg:#f5f8ff; --panel:#ffffff; --text:#0b1020; --sub:#4b5563;
  --track:#e5ecff; --cell:#ffffff; --accent:#3b82f6; --accent2:#f59e0b; --boss:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Pretendard,Segoe UI,Arial,sans-serif}
.app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header,footer{padding:10px 14px;background:var(--panel);border-bottom:1px solid #e5e7eb}
footer{border-top:1px solid #e5e7eb;border-bottom:none;color:var(--sub)}
.brand{font-weight:800}
.badge{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;background:#e5ecff;color:#0b1020}
.btn.primary{background:var(--accent);color:#fff}
.map-wrap{height:54vh;min-height:320px;background:linear-gradient(180deg,#f9fbff,#edf2ff);overflow:hidden;border-top:1px solid #e5e7eb;border-bottom:1px solid #e5e7eb}
.map-inner{height:100%;width:3000px;position:relative;transition:transform .45s cubic-bezier(.22,.61,.36,1)}
.track{position:absolute;left:40px;bottom:42%;height:16px;width:2800px;background:var(--track);border-radius:8px;box-shadow:inset 0 2px 0 #dbe5ff, 0 6px 18px rgba(0,0,0,.08)}
.cell{position:absolute;bottom:calc(42% + 8px);transform:translateX(-50%);width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid #e5e7eb;background:var(--cell);color:#1f2937}
.cell.pickup{border-color:var(--accent2);background:#fff7ed}
.cell.boss{border-color:var(--boss);background:#fff1f2}
.cell.goal{border-color:#22c55e;background:#f0fdf4}
.player{position:absolute;bottom:calc(42% + 58px);transform:translateX(-50%);width:56px;height:56px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,.12);border:2px solid #e5e7eb; z-index:3}
.quiz{padding:14px;display:grid;gap:10px;background:var(--panel)}
.answers{display:grid;gap:8px}
.answers button{font-size:18px;padding:12px;border-radius:14px;background:#f3f4f6;border:1px solid #e5e7eb;text-align:left;color:#111827}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.slot{min-width:90px;min-height:40px;border:2px dashed #d1d5db;border-radius:12px;padding:6px 8px;font-size:13px;display:flex;align-items:center;justify-content:center;background:#fff}
.slot.filled{border-style:solid;background:#eef2ff}
.dice{min-width:54px;height:54px;border-radius:12px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.08);user-select:none;border:2px solid #e5e7eb}
@keyframes roll { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
.dice.rolling{animation:roll .8s ease}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:10;display:none}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:20}
.modal.open{display:grid}
.dialog{background:#fff;border:1px solid #e5e7eb;padding:16px;border-radius:14px;min-width:280px;color:#0b1020}
.picker{display:flex;gap:8px;margin:8px 0}
.picker button{font-size:26px;padding:8px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="brand">🏁 띄어쓰기 레이스</div>
      <span class="badge">턴: <span id="turnLabel">P1</span></span>
      <span class="badge">⏱ <span id="timeLeft">10:00</span></span>
      <span class="badge" id="volBadge">🔊 25%</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="startBtn" class="btn primary">시작</button>
      <button id="fsBtn" class="btn">전체화면</button>
    </div>
  </header>

  <div class="map-wrap">
    <div class="map-inner" id="mapInner">
      <div class="track"></div>
      <div id="cells"></div>
      <div class="player" id="p1" style="left:40px">🙂</div>
      <div class="player" id="p2" style="left:40px">😎</div>
    </div>
  </div>

  <section class="quiz" aria-live="polite">
    <div class="row">
      <div>🎒 슬롯:</div>
      <div class="slot" id="itemSlot">비어있음</div>
      <button id="useItemBtn" class="btn" disabled>아이템 사용</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="dice" id="dice" title="주사위">—</div>
      </div>
    </div>
    <div class="q-stem" id="qStem">시작을 누른 뒤 캐릭터 선택 → 문제 선택지 중 하나를 눌러요.</div>
    <div class="answers">
      <button id="a1" disabled>—</button>
      <button id="a2" disabled>—</button>
    </div>
  </section>

  <footer><small>룰: 정답이면 주사위(1~6)만큼 전진, 오답이면 0~2칸 후퇴. 🎁/B/🏁 칸은 정확히 착지해야 발동.</small></footer>
</div>

<div class="toast" id="toast">세로 모드예요. 가로로 돌리면 더 편해요!</div>

<!-- Character picker -->
<div class="modal" id="pickModal" role="dialog" aria-label="캐릭터 선택">
  <div class="dialog">
    <h3>캐릭터 선택</h3>
    <div>플레이어1</div>
    <div class="picker" id="p1Pick">
      <button>🙂</button><button>🦊</button><button>🐱</button><button>🐧</button>
    </div>
    <div>플레이어2</div>
    <div class="picker" id="p2Pick">
      <button>😎</button><button>🐶</button><button>🐼</button><button>🐤</button>
    </div>
    <button id="confirmPick" class="btn primary" style="width:100%;margin-top:8px">확인</button>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

// Audio
const AudioBank = {
  sfx: {
    correct: new Audio("assets/sfx/correct.wav"),
    wrong:   new Audio("assets/sfx/wrong.wav"),
    item:    new Audio("assets/sfx/item.wav"),
    boss:    new Audio("assets/sfx/boss.wav"),
    click:   new Audio("assets/sfx/click.wav")
  },
  bgm: new Audio("assets/sfx/bgm_light.wav"),
  volume: 0.25,
  setVolume(v){ this.volume=v; Object.values(this.sfx).forEach(a=>a.volume=Math.min(1,v+0.1)); this.bgm.volume=v; $('#volBadge').textContent=`🔊 ${Math.round(v*100)}%`; },
  play(name){ const a=this.sfx[name]; if(!a) return; a.currentTime=0; a.play().catch(()=>{}); },
  startBgm(){ this.bgm.loop=true; this.bgm.volume=this.volume; this.bgm.play().catch(()=>{}); },
  unlock(){ try{ Object.values(this.sfx).forEach(a=>a.play().then(()=>a.pause()).catch(()=>{})); this.bgm.play().then(()=>this.bgm.pause()).catch(()=>{}); }catch(e){} }
};

const S = {
  minutes:10, timeLeft:600, playing:false,
  cur:1,
  p1:{ char:'🙂', idx:0, item:null, shield:false },
  p2:{ char:'😎', idx:0, item:null, shield:false },
  path:[], pendingMove:0
};

function genBoard(cells=36){
  const arr=[]; let x=40; const step=72;
  for(let i=0;i<cells;i++){ arr.append ? null : null; arr.push({x, type:'NORMAL'}); x+=step; }
  [5,9,13,17,21,25,29,33].forEach(i=>{ if(arr[i]) arr[i].type='PICKUP'; });
  [15,27].forEach(i=>{ if(arr[i]) arr[i].type='BOSS'; });
  arr[cells-1].type='GOAL';
  S.path=arr;
}
function drawBoard(){
  const wrap=$('#cells'); wrap.innerHTML='';
  S.path.forEach((n,i)=>{
    const d=document.createElement('div'); d.className='cell'; d.style.left=n.x+'px';
    if(n.type==='PICKUP'){ d.classList.add('pickup'); d.textContent='🎁'; }
    else if(n.type==='BOSS'){ d.classList.add('boss'); d.textContent='B'; }
    else if(n.type==='GOAL'){ d.classList.add('goal'); d.textContent='🏁'; }
    else d.textContent=i;
    wrap.appendChild(d);
  });
}
function placePlayers(){
  ['p1','p2'].forEach((id,i)=>{
    const p=i===0?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
    $('#'+id).style.left = (n?n.x:40)+'px';
  });
}
function cameraFollow(){
  const p=S.cur===1?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
  const wrapW=document.querySelector('.map-wrap').clientWidth;
  const centered=Math.max(0, Math.min(n.x - wrapW*0.45, document.querySelector('.map-inner').scrollWidth - wrapW));
  document.querySelector('.map-inner').style.transform=`translateX(${-centered}px)`;
}

let regularStack=[], bossStack=[];
async function loadDeck(){
  try{
    const r=await fetch('questions.json?ts='+Date.now()); const data=await r.json();
    regularStack = shuffle([...data.regular]); bossStack=shuffle([...data.boss]);
  }catch(e){
    regularStack=[{q:"나는밥을먹어요",correct:"나는 밥을 먹어요",wrong:"나는밥을 먹어요"}];
    bossStack=[{q:"학교앞에버스가와요",correct:"학교 앞에 버스가 와요",wrong:"학교앞 에 버스 가 와요"}];
  }
}
function drawQuestion(isBoss){
  const q=(isBoss? bossStack: regularStack).pop();
  if(!q){ $('#qStem').textContent='문제가 소진되었어요'; $('#a1').disabled=$('#a2').disabled=true; return null; }
  $('#qStem').innerHTML = `원문: <strong>${q.q}</strong> ${isBoss?'<span class="badge" style="background:#fee2e2;color:#991b1b">BOSS</span>':''}`;
  const opts = shuffle([{text:q.correct,ok:true},{text:q.wrong,ok:false}]);
  [$('#a1'),$('#a2')].forEach((b,i)=>{ b.textContent=opts[i].text; b.dataset.ok=opts[i].ok?'1':'0'; b.disabled=false; });
  return q;
}

function shuffle(a){ return a.sort(()=>Math.random()-0.5) }
function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}` }
function current(){ return S.cur===1?S.p1:S.p2 }
function other(){ return S.cur===1?S.p2:S.p1 }

function presentQuiz(){
  const isBoss = S.path[current().idx]?.type==='BOSS';
  drawQuestion(isBoss);
  cameraFollow();
  $('#dice').textContent='—';
}
function onAnswer(ok){
  [$('#a1'),$('#a2')].forEach(b=>b.disabled=true);
  AudioBank.play(ok? 'correct':'wrong');
  autoRoll(ok);
}
function autoRoll(isCorrect){
  const dice=$('#dice'); dice.classList.add('rolling');
  let ticks=10, val=1;
  const timer=setInterval(()=>{
    val = isCorrect? (1+Math.floor(Math.random()*6)) : Math.floor(Math.random()*3);
    dice.textContent=String(val);
    if(--ticks<=0){
      clearInterval(timer); dice.classList.remove('rolling');
      S.pendingMove = isCorrect? val : -val;
      resolveMove();
    }
  },80);
}
function resolveMove(){
  const p=current();
  p.idx = Math.max(0, Math.min(p.idx + S.pendingMove, S.path.length-1));
  placePlayers(); cameraFollow();
  const tile=S.path[p.idx];
  if(tile?.type==='PICKUP' && !p.item){
    p.item = randItem(); $('#itemSlot').textContent=p.item; $('#itemSlot').classList.add('filled'); $('#useItemBtn').disabled=false; AudioBank.play('item');
  }
  if(tile?.type==='BOSS'){
    AudioBank.play('boss');
    const q = drawQuestion(true);
    if(q){
      const handler=(e)=>{
        const ok = e.currentTarget.dataset.ok==='1';
        [$('#a1'),$('#a2')].forEach(b=>b.removeEventListener('click', handler));
        if(ok){ p.idx = Math.min(S.path.length-1, p.idx+2); }
        else { if(!p.shield){ p.idx = Math.max(0, p.idx-1); } else { p.shield=false; } }
        placePlayers(); cameraFollow();
        swapTurn();
      };
      [$('#a1'),$('#a2')].forEach(b=>b.addEventListener('click', handler, {once:true}));
      return;
    }
  }
  if(tile?.type==='GOAL'){ $('#qStem').innerHTML=`<strong>P${S.cur} 골인! 🎉</strong>`; S.playing=false; return; }
  swapTurn();
}
function swapTurn(){ S.cur = S.cur===1?2:1; updateHUD(); presentQuiz(); }
function randItem(){ return shuffle(['BOOST','PUSH','BACK','SHIELD'])[0]; }
function useItem(){
  const p=current(); const it=p.item; if(!it) return;
  if(it==='BOOST'){ p.idx = Math.min(S.path.length-1, p.idx+2); }
  else if(it==='BACK'){ p.idx = Math.max(0, p.idx-1); }
  else if(it==='PUSH'){ const op=other(); op.idx = Math.max(0, op.idx-1); }
  else if(it==='SHIELD'){ p.shield=true; }
  p.item=null; $('#itemSlot').textContent='비어있음'; $('#itemSlot').classList.remove('filled'); $('#useItemBtn').disabled=true;
  placePlayers(); cameraFollow(); AudioBank.play('click');
}

let timerId=null;
function updateHUD(){ $('#turnLabel').textContent=S.cur===1?'P1':'P2'; $('#timeLeft').textContent=fmt(S.timeLeft); }
function startTimer(){
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ if(!S.playing) return; S.timeLeft--; if(S.timeLeft<=0){ S.playing=false; $('#qStem').innerHTML='<strong>시간 종료!</strong>'; $('#a1').disabled=$('#a2').disabled=true; } updateHUD(); },1000);
}

// character
let p1Pick='🙂', p2Pick='😎';
$('#p1Pick').addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') p1Pick=e.target.textContent; });
$('#p2Pick').addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') p2Pick=e.target.textContent; });
$('#confirmPick').addEventListener('click', ()=>{ $('#p1').textContent=p1Pick; $('#p2').textContent=p2Pick; $('#pickModal').classList.remove('open'); boot(); });

async function boot(){
  S.playing=true; S.cur=1; S.timeLeft=600;
  S.p1.idx=0; S.p2.idx=0; S.p1.item=null; S.p2.item=null;
  await loadDeck(); genBoard(36); drawBoard(); placePlayers(); updateHUD(); presentQuiz(); startTimer();
  AudioBank.startBgm();
}

$('#startBtn').addEventListener('click', ()=>{ AudioBank.unlock(); $('#pickModal').classList.add('open'); });
$('#fsBtn').addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });
$('#a1').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
$('#a2').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
$('#useItemBtn').addEventListener('click', useItem);

function checkOrientation(){ const isPortrait = window.matchMedia('(orientation: portrait)').matches; $('#toast').style.display = isPortrait?'block':'none'; }
window.addEventListener('resize', checkOrientation); checkOrientation();
</script>
</body>
</html>
