<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>띄어쓰기 레이스 V3 — Dice Board</title>
<style>
:root{ --bg:#0b1220; --panel:#0f1629; --text:#eaf2ff; --accent:#66e0a3; --accent2:#ffd166; --boss:#ff3b3b; }
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Pretendard,Segoe UI,Arial,sans-serif}
.app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header,footer{padding:8px 12px;background:rgba(255,255,255,.04);backdrop-filter:blur(6px)}
header{display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;z-index:5}
.badge{padding:6px 10px;border-radius:999px;background:#1e263b;font-size:12px}
.btn{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;background:#1f2a44;color:var(--text)}
.btn.primary{background:var(--accent);color:#062012}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2)}
.map-wrap{height:56vh;min-height:320px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#0c1322,#0a101a);overflow:hidden}
.map-inner{height:100%;width:3200px;position:relative;transition:transform .45s cubic-bezier(.22,.61,.36,1)}
.track{position:absolute;left:40px;bottom:42%;height:12px;width:3000px;background:linear-gradient(180deg,#4c5a7a,#24304e);border-radius:6px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.cell{position:absolute;bottom:calc(42% + 6px);transform:translateX(-50%);width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;border:2px solid rgba(255,255,255,.18);background:#0f1730}
.cell.pickup{border-color:var(--accent2)}
.cell.boss{border-color:var(--boss);box-shadow:0 0 10px rgba(255,59,59,.6)}
.cell.goal{border-color:#8be9fd;box-shadow:0 0 10px rgba(139,233,253,.6)}
.player{position:absolute;bottom:calc(42% + 44px);transform:translateX(-50%);width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 6px 16px rgba(0,0,0,.35)}
.p1{background:#ffd166;color:#5b4100}
.p2{background:#a0c4ff;color:#0c2b5e}
.quiz{padding:12px;display:grid;gap:10px;background:rgba(255,255,255,.04)}
.answers{display:grid;gap:8px}
.answers button{font-size:18px;padding:12px;border-radius:14px;background:#0f1730;border:1px solid rgba(255,255,255,.15);text-align:left}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.slot{min-width:80px;min-height:36px;border:1px dashed rgba(255,255,255,.3);border-radius:10px;padding:6px 8px;font-size:12px;display:flex;align-items:center;justify-content:center}
.slot.filled{border-style:solid;background:rgba(255,255,255,.06)}
.dice{width:54px;height:54px;border-radius:12px;background:#fff;color:#111;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.35);user-select:none}
@keyframes roll { 0%{transform:rotate(0)} 50%{transform:rotate(180deg)} 100%{transform:rotate(360deg)} }
.dice.rolling{animation:roll .8s ease}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:10;display:none}
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex;gap:8px;align-items:center">
      <strong>🎲 띄어쓰기 레이스 V3</strong>
      <span class="badge">턴: <span id="turnLabel">P1</span></span>
      <span class="badge" id="phaseBadge">PHASE: QUIZ</span>
      <span class="badge">⏱ <span id="timeLeft">10:00</span></span>
      <span class="badge" id="themeBadge">theme: forest</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="startBtn" class="btn primary">시작</button>
      <button id="fsBtn" class="btn ghost">전체화면</button>
    </div>
  </header>

  <div class="map-wrap">
    <div class="map-inner" id="mapInner">
      <div class="track"></div>
      <div id="cells"></div>
      <div class="player p1" id="p1" style="left:40px">🙂</div>
      <div class="player p2" id="p2" style="left:40px">😎</div>
    </div>
  </div>

  <section class="quiz" aria-live="polite">
    <div class="row">
      <div>🎒 슬롯:</div>
      <div class="slot" id="itemSlot">비어있음</div>
      <button id="useItemBtn" class="btn ghost" disabled>아이템 사용</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="dice" id="dice" title="주사위">—</div>
        <button id="rollBtn" class="btn" disabled>주사위 굴리기</button>
      </div>
    </div>
    <div class="q-stem" id="qStem">정답 시 주사위를 굴려 앞으로(1~6), 오답이면 패널티 주사위(0~2) 뒤로!</div>
    <div class="answers">
      <button id="a1" disabled>—</button>
      <button id="a2" disabled>—</button>
    </div>
  </section>

  <footer><small>맵 아이템은 **정확히 착지**해야 획득합니다. 보스 칸도 정확히 올라서야 발동.</small></footer>
</div>

<div class="toast" id="toast">세로 모드예요. 가로로 돌리면 더 편해요!</div>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

// Stub audio (optional real files can be placed under assets/sfx)
const AudioBank = {
  play(){}, playBgm(){}, unlock(){}
};

const S = {
  theme:'forest', minutes:10, timeLeft:600, playing:false,
  cur:1, phase:'QUIZ',
  p1:{ char:'🙂', idx:0, item:null, shield:false },
  p2:{ char:'😎', idx:0, item:null, shield:false },
  path:[], regularDeck:[], bossDeck:[],
  pendingMove:0
};

function genBoard(cells=40){
  const arr=[]; let x=40; const step=70;
  for(let i=0;i<cells;i++){ arr.push({x, type:'NORMAL'}); x+=step; }
  [4,7,11,15,21,26,30,34].forEach(i=>{ if(arr[i]) arr[i].type='PICKUP'; });
  [18,32].forEach(i=>{ if(arr[i]) arr[i].type='BOSS'; });
  arr[cells-1].type='GOAL';
  S.path=arr;
}
function drawBoard(){
  const wrap=$('#cells'); wrap.innerHTML='';
  S.path.forEach((n,i)=>{
    const d=document.createElement('div'); d.className='cell'; d.style.left=n.x+'px';
    if(n.type==='PICKUP'){ d.classList.add('pickup'); d.textContent='🎁'; }
    else if(n.type==='BOSS'){ d.classList.add('boss'); d.textContent='B'; }
    else if(n.type==='GOAL'){ d.classList.add('goal'); d.textContent='🏁'; }
    else d.textContent=i;
    wrap.appendChild(d);
  });
}
function placePlayers(){
  ['p1','p2'].forEach((id,i)=>{
    const p=i===0?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
    $('#'+id).style.left = (n?n.x:40)+'px';
  });
}
function cameraFollow(){
  const p=S.cur===1?S.p1:S.p2; const n=S.path[Math.min(p.idx,S.path.length-1)];
  const wrapW=document.querySelector('.map-wrap').clientWidth;
  const centered=Math.max(0, Math.min(n.x - wrapW*0.45, document.querySelector('.map-inner').scrollWidth - wrapW));
  document.querySelector('.map-inner').style.transform=`translateX(${-centered}px)`;
}

let regularStack=[], bossStack=[];
async function loadDeck(){
  try{
    const r=await fetch('questions.json?ts='+Date.now()); const data=await r.json();
    regularStack = shuffle([...data.regular]); bossStack=shuffle([...data.boss]);
  }catch(e){ regularStack=[{q:"나는밥을먹어요",correct:"나는 밥을 먹어요",wrong:"나는밥을 먹어요"}]; bossStack=[{q:"학교앞에버스가와요",correct:"학교 앞에 버스가 와요",wrong:"학교앞 에 버스 가 와요"}]; }
}
function drawQuestion(isBoss){
  const q=(isBoss? bossStack: regularStack).pop();
  if(!q){ $('#qStem').textContent='문제가 소진되었어요'; $('#a1').disabled=$('#a2').disabled=true; return null; }
  $('#qStem').innerHTML = `원문: <strong>${q.q}</strong> ${isBoss?'<span class="badge" style="background:rgba(255,59,59,.18);color:#ffaeae">BOSS</span>':''}`;
  const opts = shuffle([{text:q.correct,ok:true},{text:q.wrong,ok:false}]);
  [$('#a1'),$('#a2')].forEach((b,i)=>{ b.textContent=opts[i].text; b.dataset.ok=opts[i].ok?'1':'0'; b.disabled=false; });
  return q;
}

// utils
function shuffle(a){ return a.sort(()=>Math.random()-0.5) }
function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}` }
function current(){ return S.cur===1?S.p1:S.p2 }
function other(){ return S.cur===1?S.p2:S.p1 }
function setPhase(ph){ S.phase=ph; $('#phaseBadge').textContent='PHASE: '+ph; }

function presentQuiz(){
  setPhase('QUIZ');
  const isBoss = S.path[current().idx]?.type==='BOSS';
  drawQuestion(isBoss);
  cameraFollow();
  $('#rollBtn').disabled=true; $('#dice').textContent='—';
}
function onAnswer(ok){
  [$('#a1'),$('#a2')].forEach(b=>b.disabled=true);
  setPhase('ROLL');
  $('#rollBtn').disabled=false;
  $('#rollBtn').textContent = ok? '주사위 굴리기 (앞으로)' : '패널티 주사위 (뒤로)';
}
function rollDice(){
  if(S.phase!=='ROLL') return;
  const dice=$('#dice'); dice.classList.add('rolling');
  const forward = $('#rollBtn').textContent.includes('앞으로');
  let ticks=10, val=1;
  const timer=setInterval(()=>{
    val = forward? (1+Math.floor(Math.random()*6)) : Math.floor(Math.random()*3); // 0..2
    dice.textContent=String(val);
    if(--ticks<=0){
      clearInterval(timer); dice.classList.remove('rolling');
      S.pendingMove = forward? val : -val;
      resolveMove();
    }
  },80);
}
function resolveMove(){
  setPhase('RESOLVE');
  const p=current();
  p.idx = Math.max(0, Math.min(p.idx + S.pendingMove, S.path.length-1));
  placePlayers(); cameraFollow();
  const tile=S.path[p.idx];
  if(tile?.type==='PICKUP' && !p.item){
    p.item = randItem();
    $('#itemSlot').textContent=p.item; $('#itemSlot').classList.add('filled'); $('#useItemBtn').disabled=false;
  }
  if(tile?.type==='BOSS'){
    // boss challenge immediate
    const q = drawQuestion(true);
    if(q){
      // temporarily intercept clicks for boss resolution
      const h = (ok)=>{
        [$('#a1'),$('#a2')].forEach(b=>b.removeEventListener('click', bossHandler));
        if(ok){ p.idx = Math.min(S.path.length-1, p.idx+2); }
        else { p.idx = Math.max(0, p.idx-1); }
        placePlayers(); cameraFollow();
        swapTurn();
      };
      function bossHandler(e){ h(e.currentTarget.dataset.ok==='1'); }
      [$('#a1'),$('#a2')].forEach(b=>{ b.addEventListener('click', bossHandler, {once:true}); });
      return;
    }
  }
  if(tile?.type==='GOAL'){ $('#qStem').innerHTML=`<strong>P${S.cur} 골인! 🎉</strong>`; S.playing=false; $('#rollBtn').disabled=true; return; }
  swapTurn();
}
function swapTurn(){
  S.cur = S.cur===1?2:1; updateHUD(); presentQuiz();
}
function randItem(){ return shuffle(['BOOST','PUSH','BACK','SHIELD'])[0]; }
function useItem(){
  const p=current(); const it=p.item; if(!it) return;
  if(it==='BOOST'){ p.idx = Math.min(S.path.length-1, p.idx+2); }
  else if(it==='BACK'){ p.idx = Math.max(0, p.idx-1); }
  else if(it==='PUSH'){ const op=other(); op.idx = Math.max(0, op.idx-1); }
  else if(it==='SHIELD'){ p.shield=true; }
  p.item=null; $('#itemSlot').textContent='비어있음'; $('#itemSlot').classList.remove('filled'); $('#useItemBtn').disabled=true;
  placePlayers(); cameraFollow();
}

let timerId=null;
function updateHUD(){ $('#turnLabel').textContent=S.cur===1?'P1':'P2'; $('#timeLeft').textContent=fmt(S.timeLeft); }
function startTimer(){
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ if(!S.playing) return; S.timeLeft--; if(S.timeLeft<=0){ S.playing=false; $('#qStem').innerHTML='<strong>시간 종료!</strong>'; $('#a1').disabled=$('#a2').disabled=true; $('#rollBtn').disabled=true; } updateHUD(); },1000);
}

// events
$('#a1').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
$('#a2').addEventListener('click', e=> onAnswer(e.currentTarget.dataset.ok==='1'));
$('#rollBtn').addEventListener('click', rollDice);
$('#useItemBtn').addEventListener('click', useItem);
$('#fsBtn').addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });
$('#startBtn').addEventListener('click', async ()=>{
  AudioBank.unlock();
  S.playing=true; S.cur=1; S.phase='QUIZ'; S.timeLeft=600;
  S.p1.idx=0; S.p2.idx=0; S.p1.item=null; S.p2.item=null;
  await loadDeck(); genBoard(40); drawBoard(); placePlayers(); updateHUD(); presentQuiz(); startTimer();
});

function checkOrientation(){ const isPortrait = window.matchMedia('(orientation: portrait)').matches; $('#toast').style.display = isPortrait?'block':'none'; }
window.addEventListener('resize', checkOrientation); checkOrientation();
</script>
</body>
</html>
